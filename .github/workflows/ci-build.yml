name: CI

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

# Add permissions configuration
permissions:
  contents: read
  actions: read
  packages: read
  id-token: write  # Required for OAuth authentication

env:
  GHCR_ORG: avarcorg

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Pack CLI
        uses: buildpacks/github-actions/setup-pack@v5.8.11

      - name: Display Pack CLI
        run: pack --version

      - name: Set up Pack Tools
        uses: buildpacks/github-actions/setup-tools@v5.8.11

      - name: Display Pack Tools
        run: yj -v

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '22.14.0'

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Extract Maven project version
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build with Maven
        run: mvn --no-transfer-progress -DskipTests -Pwith-docker clean package

      - name: Run Tests
        run: mvn test -pl avarc-backend

      - name: Run Modulith Tests
        continue-on-error: true
        run: mvn test -pl avarc-backend -Pwith-modulith

  build-and-push-container-images:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Pack CLI
        uses: buildpacks/github-actions/setup-pack@v5.8.11

      - name: Display Pack CLI
        run: pack --version

      - name: Set up Pack Tools
        uses: buildpacks/github-actions/setup-tools@v5.8.11

      - name: Display Pack Tools
        run: yj -v

      - name: Extract Maven project version
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build docker images
        run: mvn --no-transfer-progress -DskipTests -Dmaven.test.skip=true -Dmaven.main.skip=true -Dspring-boot.repackage.skip=true -Dspring-boot.build-image.skip=false -Pwith-docker package

      - name: Show Docker image(s)
        run: |
          docker images | sort

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Show Docker image label(s)
        run: |
          docker inspect --format="{{json .Config.Labels}}" ghcr.io/${{ env.GHCR_ORG  }}/avarc-backend:${{ env.VERSION }} | jq "."
          echo
          docker inspect --format="{{json .Config.Labels}}" ghcr.io/${{ env.GHCR_ORG  }}/avarc-frontend:${{ env.VERSION }} | jq "."
          echo
          docker inspect --format="{{json .Config.Labels}}" ghcr.io/${{ env.GHCR_ORG  }}/avarc-nginx:${{ env.VERSION }} | jq "."

  trigger-deployment:
    needs: build-and-push-container-images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Connect to Tailscale
        id: tailscale
        # Required OAuth client permissions:
        # - auth_keys
        # - device_invites:read
        # - devices:core
        # - devices:posture_attributes:read
        # - devices:routes
        # - dns:read
        uses: tailscale/github-action@v2
        continue-on-error: true
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: 'tag:deploy-avarc'
          hostname: github-runner-${{ github.run_id }}

      - name: Show tailscaled.log
        run: |
          echo "=== tailscaled.log contents ==="
          cat ~/tailscaled.log || echo "No tailscaled.log found"
          echo "=== End of tailscaled.log ==="

      - name: Trigger deployment
        if: success()
        run: |
          curl -X POST ${{ secrets.DEPLOYMENT_TRIGGER_URL }} \
            -H "Content-Type: application/json" \
            --data "{\"version\": \"${{ env.VERSION }}\"}"
